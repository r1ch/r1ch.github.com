<html>
  <head>
    <title>Bradi.sh</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="window/d3-delaunay.min.js"></script>
    <script src="window/paths.js"></script>
  </head>
  <body bgcolor="#000000">
     <div id = "d3"></div>
     <script>
       let data = {
        fullWidth: window.innerWidth,
        fullHeight: 200,
        N: 40,
        margin: {
         left: 0,
         right: 0,
         top: 0,
         bottom: 0,
        }
       };
       data.width = data.fullWidth - data.margin.left - data.margin.right
       data.height = data.fullHeight - data.margin.top - data.margin.bottom

       let svg = d3.select("#d3")
        .append("svg")
        .attr('width', data.fullWidth)
        .attr('height', data.fullHeight)
        .call(responsivefy)

       let defs = svg
        .append("defs")
        
       let filters = defs
        .selectAll("filter")
        .data([0, 1, 2, 3, 4, 5])
        .enter()
        .append("filter")
        .attr("id", (d) => `blur${d}`)
        .append("feGaussianBlur")
        .attr("stdDeviation", d => d/3);
       
       let clipPath = defs
       .append("clipPath")
       .attr("id","letter-clip")
       .append("text")
       .attr("x","50%")
       .attr("y","50%")
       .attr("dominant-baseline","middle")
       .attr("text-anchor","middle")
       .text("bradish")
       .attr("font-size", function(d) { return Math.min(data.height,(data.width / this.getComputedTextLength() * 12)) + "px"; })
       .attr("font-family","sans-serif")
       .attr("font-weight","bold")

       let background = svg
       .append('g')
       .attr("width",data.width)
       .attr("height",data.height)
       
       let foreground = svg
       .append('g')
       .attr("width",data.width)
       .attr("height",data.height)
       .attr("clip-path","url(#letter-clip)")
       

       let c10 = d3.schemePaired;

       positions = Float64Array.from({
        length: data.N * 2
       }, (_, i) => Math.random() * (i & 1 ? data.height : data.width))
       velocities = new Float64Array(data.N * 2)


       let voronoi = new d3.Delaunay(positions).voronoi([0, 0, data.width, data.height]);

       let cellUpdate = () => {
        let cell = foreground
         .selectAll(".cell")
         .data([...voronoi.cellPolygons()])

        cell
         .exit()
         .remove()

        cell
         .attr("d", (d) => {
          return "M" + d.join("L") + "Z"
         })

        cell
         .enter()
         .append("path")
         .attr("class", "cell")
         .attr("stroke", "black")
         .attr("fill", (d, i) => c10[i % 10])
         .attr("stroke-width", 5)
         .attr("d", (d) => {
          return "M" + d.join("L") + "Z"
         })
         .attr("filter", (d, i) => `url(#blur${i%5})`);

       }

       let meshUpdate = () => {
        let mesh = background
         .selectAll(".mesh")
         .data([voronoi.render()])

        mesh
         .exit()
         .remove()

        mesh
         .attr("d",function(d){return d})

        mesh
         .enter()
         .append("path")
         .attr("class", "mesh")
         .attr("stroke", "white")
         .attr("fill", (d, i) => c10[(i+1) % 10])
         .attr("stroke-width", 1)
         .attr("d",function(d){return d})

       }

       let update = () => {
        for (let i = 0; i < positions.length ; ++i) {
         const size = i & 1 ? data.height : data.width;
         positions[i] += velocities[i];
         if (positions[i] < 0) positions[i] += size;
         else if (positions[i] > size) positions[i] -= size;
         velocities[i] += 0.2 * (Math.random() - 0.5) - 0.01 * velocities[i];
        }
        voronoi = new d3.Delaunay(positions).voronoi([0, 0, data.width, data.height]);
        //meshUpdate()
        cellUpdate()

       }
       
       function responsivefy(svg) {
        var container = d3.select(svg.node().parentNode),
            width = parseInt(svg.style("width")),
            height = parseInt(svg.style("height")),
            aspect = width / height;

        svg.attr("viewBox", "0 0 " + width + " " + height)
            .attr("preserveAspectRatio", "xMinYMid")
            .call(resize);

        d3.select(window).on("resize." + container.attr("id"), resize);


        function resize() {
            var targetWidth = parseInt(container.style("width"));
            svg.attr("width", targetWidth);
            svg.attr("height", Math.round(targetWidth / aspect));
        }
      }
       
       
       setInterval(update, 1000/24)
    </script>
  </body>
</html>
