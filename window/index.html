<html>
  <head>
    <title>Bradi.sh</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="d3-delaunay.min.js"></script>
    <script src="paths.js"></script>
  </head>
  <body>
     <div id = "d3" style="width:100 vw;height:100 vh"></div>
     <script>
       
        let data = {
          fullWidth:800,
          fullHeight:300,
          radius:5,
          speed:1,
          margin:{
            left:10,
            right:10,
            top:10,
            bottom:10,
          }
        };
        data.width = data.fullWidth - data.margin.left - data.margin.right
        data.height = data.fullHeight - data.margin.top - data.margin.bottom
        let svg = d3.select("#d3")
        .append("svg")
        .attr('width',data.fullWidth)
        .attr('height',data.fullHeight)
        .append("g")
        .attr('width',data.width)
        .attr('height',data.height)      
        .attr("transform", `translate(${data.margin.left},${data.margin.right})`)
        
        let space = 0;
        
        let clip = svg
        .append("clipPath")
        .attr("id", "letter-clip")
        .selectAll(".letter")
        .data(paths)
        .enter()
        .append("path")
        .attr("d",function(d){return d.path})
        .attr("class",function(d){return `letter ${d.letter}`})
        .attr("transform",function(d){
          let translate = `scale(3,3) translate(${space},0)`
          space += this.getBBox().width + 10
          return translate
        })
        
       let c10 = d3.schemePaired;
       let t = d3.transition().duration(750);
       
       let points = d3.range(40).map(i => ({
          x: Math.random() * (data.width - data.radius) + data.radius,
          y: Math.random() * (data.height - data.radius) + data.radius,
        }));
       
       let velocities = d3.range(40).map(i=>({vx:0,vy:0}))
       
       svg.append("defs")
      .append("filter")
      .attr("id", "blur")
      .append("feGaussianBlur")
      .attr("stdDeviation", 1); 
       
      let voronoi = d3.Delaunay
      .from(points, d => d.x, d => d.y)
      .voronoi([0, 0, data.width, data.height]);
       
       let cellUpdate = ()=>{
          let cell = svg
          .selectAll(".cell")
          .data(points)
          
          cell
          .exit()
          .remove()
         
          cell
          .attr("d", (d,i)=>voronoi.renderCell(i))
         
          cell
          .enter()
          .append("path")
          .attr("cell", "cell")
          .attr("stroke", "none")
          .attr("clip-path","url(#letter-clip)")
          .attr("fill",(d,i)=>c10[i%10])
          .attr("stroke-width", 1)
          .attr("d", (d,i)=>voronoi.renderCell(i))
          .attr("filter", "url(#blur)");
          
       }
       
       let meshUpdate = ()=>{
          let cell = svg
          .selectAll(".mesh")
          .data(points)
          
          cell
          .exit()
          .remove()
         
          cell
          .attr("d", (d,i)=>voronoi.renderCell(i))
         
          cell
          .enter()
          .append("path")
          .attr("class", "mesh")
          .attr("stroke", "#ccc")
          .attr("fill","none")
          .attr("stroke-width", 1)
          .attr("d", (d,i)=>voronoi.renderCell(i))
          
       }
       

      let update = ()=>{
          points.forEach((point,i)=>{
            point.x = (data.width + point.x + velocities[i].vx) % data.width
            point.y = (data.height + point.y + velocities[i].vy) % data.height
            velocities[i].vx += 0.2 * (Math.random() -0.5) - 0.01 * velocities[i].vx
            velocities[i].vy += 0.2 * (Math.random() -0.5) - 0.01 * velocities[i].vy
          })
          voronoi = d3.Delaunay.from(points, d => d.x, d => d.y).voronoi([0, 0, data.width, data.height]);
          cellUpdate()
          //meshUpdate()
      }
      
    </script>
  </body>
</html>
