<html>
  <head>
    <title>Bradi.sh</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="d3-delaunay.min.js"></script>
    <script src="paths.js"></script>
  </head>
  <body>
     <div id = "d3" style="width:100 vw;height:100 vh"></div>
     <script>
       let data = {
        fullWidth: 960,
        fullHeight: 400,
        radius: 5,
        n: 40,
        N: 200,
        margin: {
         left: 10,
         right: 10,
         top: 10,
         bottom: 10,
        }
       };
       data.width = data.fullWidth - data.margin.left - data.margin.right
       data.height = data.fullHeight - data.margin.top - data.margin.bottom

       let svg = d3.select("#d3")
        .append("svg")
        .attr('width', data.fullWidth)
        .attr('height', data.fullHeight)
        .call(responsivefy)

       svg
        .append("defs")
        .selectAll("filter")
        .data([0, 1, 2, 3, 4, 5])
        .enter()
        .append("filter")
        .attr("id", (d) => `blur${d}`)
        .append("feGaussianBlur")
        .attr("stdDeviation", d => d * 2);

       let stage = svg
        .append("g")
        .attr('width', data.width)
        .attr('height', data.height)
        .attr("transform", `translate(${data.margin.left},${data.margin.right})`)

       let space = 0;

       let clip = stage
        .append("clipPath")
        .attr("id", "letter-clip")
        .selectAll(".letter")
        .data(paths)
        .enter()
        .append("path")
        .attr("d",d=>d)
        .attr("class", "letter")
        .attr("transform", function(d) {
         let translate = `scale(3,3) translate(${space},${data.height/6})`
         space += this.getBBox().width + 10
         return translate
        })
       
       let background = stage
       .append('g')
       .attr("width",data.width)
       .attr("height",data.height)
       
       let foreground = stage
       .append('g')
       .attr("width",data.width)
       .attr("height",data.height)
       .attr("clip-path","url(#letter-clip)")
       

       let c10 = d3.schemePaired;

       positions = Float64Array.from({
        length: data.N * 2
       }, (_, i) => Math.random() * (i & 1 ? data.height : data.width))
       velocities = new Float64Array(data.N * 2)


       let voronoi = new d3.Delaunay(positions.slice(0,data.n*2)).voronoi([0, 0, data.width, data.height]);

       let cellUpdate = () => {
        let cell = foreground
         .selectAll(".cell")
         .data([...voronoi.cellPolygons()])

        cell
         .exit()
         .remove()

        cell
         .attr("d", (d) => {
          return "M" + d.join("L") + "Z"
         })

        cell
         .enter()
         .append("path")
         .attr("class", "cell")
         .attr("stroke", "#ccc")
         .attr("fill", (d, i) => c10[i % 10])
         .attr("stroke-width", 5)
         .attr("d", (d) => {
          return "M" + d.join("L") + "Z"
         })
         .attr("filter", (d, i) => `url(#blur${i%5})`);

       }

       let meshUpdate = () => {
        let mesh = background
         .selectAll(".mesh")
         .data([voronoi.render()])

        mesh
         .exit()
         .remove()

        mesh
         .attr("d", d => d)

        mesh
         .enter()
         .append("path")
         .attr("class", "mesh")
         .attr("stroke", "#ccc")
         .attr("fill", "none")
         .attr("stroke-width", 1)
         .attr("d", d => d)

       }

       let update = () => {
        for (let i = 0; i < data.n*2; ++i) {
         const size = i & 1 ? data.height : data.width;
         positions[i] += velocities[i];
         if (positions[i] < 0) positions[i] += size;
         else if (positions[i] > size) positions[i] -= size;
         velocities[i] += 0.2 * (Math.random() - 0.5) - 0.01 * velocities[i];
        }
        voronoi = new d3.Delaunay(positions.slice(data.n*2)).voronoi([0, 0, data.width, data.height]);
        meshUpdate()
        cellUpdate()

       }
       
       function responsivefy(svg) {
        var container = d3.select(svg.node().parentNode),
            width = parseInt(svg.style("width")),
            height = parseInt(svg.style("height")),
            aspect = width / height;

        svg.attr("viewBox", "0 0 " + width + " " + height)
            .attr("preserveAspectRatio", "xMinYMid")
            .call(resize);

        d3.select(window).on("resize." + container.attr("id"), resize);


        function resize() {
            var targetWidth = parseInt(container.style("width"));
            svg.attr("width", targetWidth);
            svg.attr("height", Math.round(targetWidth / aspect));
        }
      }
       
       
       setInterval(update, 20)
    </script>
  </body>
</html>
